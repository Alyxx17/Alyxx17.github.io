---
title: 无约束MPC基本原理
date: 2026-02-05 10:00:00 +0800
categories: [控制,MPC]
tags: [控制]
math: true  # <-- 就是这一行，启用本页的数学公式渲染
---

## 核心原理
MPC控制的基本原理可以概括为：在每个采样时刻用最新得到的测量值刷新优化问题，并求解刷新后的优化问题,将得到的优化解（可能只是次优解）的第一个分量 $u^*(k|k)$作用于系统,如此循环往复至永远。
换句话说，预测控制算法包括三个步骤：  

（1）预测系统未来动态:  

（2）(数值) 求解优化问题;  

（3） 将优化解的第一个元素 (或者说一部分)作用于系统；  

实际上通俗来说，MPC预测控制有点类似于下棋：根据当前时刻的状态预测推演接下来的几步，但是只下一步，如此往复。  
## 增量离散状态空间模型

考虑如下连续时间域的状态空间方程:  

$$
\begin{aligned}
\dot{x}(t) &= A_c x(t) + B_{cu} u(t) + B_{cd} d(t); \\
y_c(t) &= C_c x(t).
\end{aligned}
$$  

其中$x(t)$是状态变量，$u(t)$是控制输入变量，$d(t)$是可以测量的外部干扰变量， $y_c$ 是被控输出变量;  

为了便于计算机控制，将上述连续时间域的状态空间方程转化为离散时间域的状态空间方程。其系数有如下关系：  

\begin{aligned}
A & =\mathrm{e}^{A_{c} T_{s}} 
\end{aligned}  

\begin{aligned}
B_{u} & =\int_{0}^{T_{s}} \mathrm{e}^{A_{c} \tau} \mathrm{~d} \tau \cdot B_{c u}
\end{aligned}  

\begin{aligned}
B_{d} & =\int_{0}^{T_{s}} \mathrm{e}^{A_{c} \tau} \mathrm{~d} \tau \cdot B_{c d}
\end{aligned}  
其中Ts为采样时间。  
因此，离散域的状态空间方程可以表示为:  

$$
\begin{aligned}
x(k+1) &= Ax(k) + B_u u(k) + B_d d(k); \\
y_c(k) &= C_c x(k).
\end{aligned}
$$  

为了引入积分作用以减小或消除静态误差，采用增量离散状态空间模型。  
定义:
\begin{aligned}
Δx(k) &= x(k)-x(k-1);
\end{aligned}  

\begin{aligned}
Δu(k) &= u(k)-u(k-1);
\end{aligned}  

\begin{aligned}
Δd(k) &= d(k)-d(k-1);
\end{aligned}  

由此可得增量离散状态空间模型为：  

$$
\begin{aligned}
\Delta x(k+1) &= A \Delta x(k) + B_u \Delta u(k) + B_d \Delta d(k); \\
y_c(k) &= C_c \Delta x(k) + y_c(k-1).
\end{aligned}
$$  

本文以后的推导都基于这个增量离散状态空间模型（下称“状态空间模型”）。  
## 预测方程  
这一节将讨论MPC的第一个步骤：基于上述的状态空间模型预测系统未来的动态。  
假设所有状态变量均可测量，以最新的测量值为初始条件，设置预测时域为$p$，控制时域为$m$，且$m$≤$p$。为了便于推导，作如下假设：  
(1)控制时域之外，控制量不变，即$Δu(k+i)$=$0$,$i$=$m$,$m+1$,......,$p-1$;  

(2)可测干扰在k时刻之后保持不变，即$Δd(k+i)$=$0$,$i$=$1$,$2$,......,$p$;  


基于这两个假设，先预测状态变量，在当前时刻$k$,测量值为$x(k)$,可以计算$Δx(k)=x(k)-x(k-1)$，这个$Δx(k)$将作为预测系统未来状态的起点。式中$(k+i\vert k)$代表从$k$开始预测到$k+i$时刻。即：  

$$
\begin{aligned}
\Delta x(k+1|k) &= A\Delta x(k) + B_u\Delta u(k) + B_d\Delta d(k), \\
\Delta x(k+2|k) &= A\Delta x(k+1|k) + B_u\Delta u(k+1) + B_d\Delta d(k+1) \\
&= A^2\Delta x(k) + AB_u\Delta u(k) + B_u\Delta u(k+1) + AB_d\Delta d(k), \\
\Delta x(k+3|k) &= A\Delta x(k+2|k) + B_u\Delta u(k+2) + B_d\Delta d(k+2) \\
&= A^3\Delta x(k) + A^2B_u\Delta u(k) + AB_u\Delta u(k+1) + B_u\Delta u(k+2) + A^2B_d\Delta d(k).
\end{aligned}
$$ 

$$
\vdots
$$



$$
\begin{aligned}
\Delta x(k + m|k) &= A\Delta x(k + m - 1|k) + B_u \Delta u(k + m - 1) + B_d \Delta d(k + m - 1) \\
&= A^m \Delta x(k) + A^{m-1} B_u \Delta u(k) + A^{m-2} B_u \Delta u(k + 1) \\
&\quad + \cdots + B_u \Delta u(k + m - 1) + A^{m-1} B_d \Delta d(k), \\
&\vdots \\
\Delta x(k + p|k) &= A\Delta x(k + p - 1|k) + B_u \Delta u(k + p - 1) + B_d \Delta d(k + p - 1) \\
&= A^p \Delta x(k) + A^{p-1} B_u \Delta u(k) + A^{p-2} B_u \Delta u(k + 1) \\
&\quad + \cdots + A^{p-m} B_u \Delta u(k + m - 1) + A^{p-1} B_d \Delta d(k).
\end{aligned}
$$  

进一步，利用上面预测的状态，可以预测被控输出： 

$$
\begin{aligned}
y_c(k+1|k) &= C_c \Delta x(k+1|k) + y_c(k) \\
&= C_c A \Delta x(k) + C_c B_u \Delta u(k) + C_c B_d \Delta d(k) + y_c(k), \\
y_c(k+2|k) &= C_c \Delta x(k+2|k) + y_c(k+1|k) \\
&= (C_c A^2 + C_c A) \Delta x(k) + (C_c AB_u + C_c B_u) \Delta u(k) \\
&\quad + C_c B_u \Delta u(k+1) + (C_c AB_d + C_c B_d) \Delta d(k) + y_c(k), \\
&\vdots \\
y_c(k+m|k) &= C_c \Delta x(k+m|k) + y_c(k+m-1|k) \\
&= \sum_{i=1}^m C_c A^i \Delta x(k) + \sum_{i=1}^m C_c A^{i-1} B_u \Delta u(k) \\
&\quad + \sum_{i=1}^{m-1} C_c A^{i-1} B_u \Delta u(k+1) + \cdots + C_c B_u \Delta u(k+m-1) \\
&\quad + \sum_{i=1}^m C_c A^{i-1} B_d \Delta d(k) + y_c(k), \\
&\vdots \\
y_c(k+p|k) &= C_c \Delta x(k+p|k) + y_c(k+p-1|k) \\
&= \sum_{i=1}^p C_c A^i \Delta x(k) + \sum_{i=1}^p C_c A^{i-1} B_u \Delta u(k) \\
&\quad + \sum_{i=1}^{p-1} C_c A^{i-1} B_u \Delta u(k+1) + \dots \\
&\quad + \sum_{i=1}^{p-m+1} C_c A^{i-1} B_u \Delta u(k+m-1) \\
&\quad + \sum_{i=1}^p C_c A^{i-1} B_d \Delta d(k) + y_c(k).
\end{aligned}
$$  

定义$p$步预测输出向量和$m$步输入向量如下:  

$$ 
\begin{aligned}
Y_p(k+1|k) \stackrel{\text{def}}{=}
  \begin{pmatrix}
  y_c(k+1|k) \\
  y_c(k+2|k) \\
  \vdots \ \\
  y_c(k+p|k) \\
  \end{pmatrix}_{p \times 1}
\end{aligned}  
$$  

$$
\begin{aligned}
\Delta U(k) \stackrel{\text{def}}{=}
\begin{bmatrix}
\Delta u(k) \\
\Delta u(k+1) \\
\vdots \\
\Delta u(k+m-1)
\end{bmatrix}_{m \times 1}.
\end{aligned}
$$  

注意：矩阵下标表示的是矩阵中向量 (或标量)的个数,不一定是矩阵的维数. 例如,上式中, $p×1$仅表示矩阵$Y_p(k+1\vert k)$中$y_c$的个数, 当$y_c$是向量时,$p×1$并不等于矩阵的维数.  

同时需要注意的是$k$时刻的$u(k)$不是已知量，而是需要施加到系统的第一个控制量。因此$Δu(k)$不是初始条件。  

那么, 根据上面的预测推导，可以将各步的矩阵系数增广组合，对系统未来$p$步预测的输出可以由下面的预测方程计算:  

$$
\begin{aligned}
Y_p(k + 1|k) = S_x \Delta x(k) + I y_c(k) + S_d \Delta d(k) + S_u \Delta U(k),
\end{aligned}
$$

其中：  

$$
\begin{aligned}
S_x = 
\begin{bmatrix}
C_c A \\
\sum_{i=1}^{2} C_c A^i \\
\vdots \\
\sum_{i=1}^{p} C_c A^i
\end{bmatrix}_{p \times 1}, \quad I =
\begin{bmatrix}
I_{n_c \times n_c} \\
I_{n_c \times n_c} \\
\vdots \\
I_{n_c \times n_c}
\end{bmatrix}_{p \times 1},
\end{aligned}
$$  

$I_{n_c \times n_c}$中的下标代表输出维数，即$C_c$的行数。

$$
\begin{aligned}
S_d =
\begin{bmatrix}
C_c B_d \\
\sum_{i=1}^2 C_c A^{i-1} B_d \\
\vdots \\
\sum_{i=1}^p C_c A^{i-1} B_d
\end{bmatrix}_{p \times 1},
\end{aligned}
$$  

$$
\begin{aligned}
S_u =
\begin{bmatrix}
C_c B_u & 0 & 0 & \cdots & 0 \\
\sum_{i=1}^2 C_c A^{i-1} B_u & C_c B_u & 0 & \cdots & 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
\sum_{i=1}^m C_c A^{i-1} B_u & \sum_{i=1}^{m-1} C_c A^{i-1} B_u & \cdots &  \cdots &C_c B_u \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
\sum_{i=1}^p C_c A^{i-1} B_u & \sum_{i=1}^{p-1} C_c A^{i-1} B_u & \cdots & \cdots &\sum_{i=1}^{p-m+1} C_c A^{i-1} B_u
\end{bmatrix}_{p \times m}
\end{aligned}
$$

$S_u$中前$m$行构成的下三角矩阵，很好的说明了系统在时间上的因果关系。比如当$S_u$与$\Delta U(k)$相乘时，第一行只有$Δu(k)$的系数不为$0$，$Δu(k+1)$，$Δu(k+2)$......的系数都为0，而这行也对应了$y_c(k+1\vert k)$，而第二行只有$Δu(k)$，$Δu(k)$的系数不为$0$,这行对应了$y_c(k+2\vert k)$，说明$k+1$时刻的输入对$k$时刻的输出没有影响，$k+2$时刻的输入对$k$，$k+1$时刻的输出没有影响，以此类推。  

为了更好的理解$S_u$矩阵，$S_u$可以表示为如下形式(假设$p=20$,$m=5$):  

$$
\begin{aligned}
S_u = 
\begin{bmatrix}
h_1 & 0 & 0 & 0 & 0 \\
h_2 & h_1 & 0 & 0 & 0 \\
h_3 & h_2 & h_1 & 0 & 0 \\
h_4 & h_3 & h_2 & h_1 & 0 \\
h_5 & h_4 & h_3 & h_2 & h_1 \\
h_6 & h_5 & h_4 & h_3 & h_2 \\
h_7 & h_6 & h_5 & h_4 & h_3 \\
h_8 & h_7 & h_6 & h_5 & h_4 \\
h_9 & h_8 & h_7 & h_6 & h_5 \\
h_{10} & h_9 & h_8 & h_7 & h_6 \\
h_{11} & h_{10} & h_9 & h_8 & h_7 \\
h_{12} & h_{11} & h_{10} & h_9 & h_8 \\
h_{13} & h_{12} & h_{11} & h_{10} & h_9 \\
h_{14} & h_{13} & h_{12} & h_{11} & h_{10} \\
h_{15} & h_{14} & h_{13} & h_{12} & h_{11} \\
h_{16} & h_{15} & h_{14} & h_{13} & h_{12} \\
h_{17} & h_{16} & h_{15} & h_{14} & h_{13} \\
h_{18} & h_{17} & h_{16} & h_{15} & h_{14} \\
h_{19} & h_{18} & h_{17} & h_{16} & h_{15} \\
h_{20} & h_{19} & h_{18} & h_{17} & h_{16}
\end{bmatrix}_{20\times5}
\end{aligned}
$$

其中：
$h_k = \displaystyle\sum_{i=1}^k C_c A^{i-1} B_u ，k = 1,2,\dots,p $  

## 求解优化问题  
目标函数的选取反映对系统性能的要求，我们希望被控输出接近参考输入，同时希望控制动作不要变化太大。考虑如下目标函数：  

$$
\begin{aligned}
J = \sum_{i=1}^p \left|| \Gamma_{y,i} (y_c(k + i|k) - r(k + i)) \right||^2 + \sum_{i=1}^m \left|| \Gamma_{u,i} \Delta u(k + i - 1) \right||^2,
\end{aligned}  
$$  

其中：  
 
$$
\begin{aligned}
\Gamma_{y,i} \stackrel{\text{def}}{=} \operatorname{diag}(\Gamma_{y_1,i}, \Gamma_{y_2,i}, \cdots, \Gamma_{y_{n_c},i}).
\end{aligned}
$$  

其中$\Gamma_{y_1,i}, \Gamma_{y_2,i}, \cdots, \Gamma_{y_{n_c},i}$为标量，代表在$i$时刻对各个输出(一共$n_c$个，即状态空间模型中矩阵$C_c$的行数）误差的加权因子。 误差加权因子越大,表明我们期望对应的控制输出越接近给定的参考输入。   

$$
\begin{aligned}
\Gamma_{u,i} \stackrel{\text{def}}{=} \operatorname{diag}(\Gamma_{u_1,i}, \Gamma_{u_2,i}, \cdots, \Gamma_{u_{n_u},i})
\end{aligned}
$$  

其中$\Gamma_{u_1,i}, \Gamma_{u_2,i}, \cdots, \Gamma_{u_{n_u},i}$为标量，代表在$i$时刻对各个控制增量（一共$n_u$个，即状态空间模型中矩阵$B_u$的列数）的加权因子。  控制加权因子越大，表明我们期望对应的控制动作变化越小。 

$r(k+i)$代表给定参考输入向量。 


为了更好地理解这两个加权因子。假设一2输入2输出系统。  

那么$i=1$时刻的误差为$(y_c(k + 1\vert k) - r(k + 1)$，这是一个$2×1$的矩阵（注意，$r(k + 1)$是参考输入，不是控制量，在维数上应和$y_c(k + 1\vert k)$相等）。  

此时对于$i=1$的2个输出分别采取不同的加权因子$\Gamma_{y_1,1}, \Gamma_{y_2,1}$，假设为$1,0.5$。即：  

$$
\begin{aligned}
\Gamma_{y,1} = \text{diag}(\Gamma_{y_1,1}, \Gamma_{y_2,1}) =
\begin{bmatrix}
1 & 0 \\
0 & 0.5
\end{bmatrix}
\end{aligned}
$$

下一个时刻$i=2$时的2个输出分别采取不同的加权因子$\Gamma_{y_1,2}, \Gamma_{y_2,2}$，假设为$0.8,1$。即：  

$$
\begin{aligned}
\Gamma_{y,2} = \text{diag}(\Gamma_{y_1, 2}, \Gamma_{y_2, 2}) =
\begin{bmatrix}
0.8 & 0 \\
0 & 1
\end{bmatrix}
\end{aligned}
$$  

同样的，$i=1$时刻的$Δu(k)$是一个$2×1$的矩阵，此时，对这个2个控制量分别采用不同的加权因子$\Gamma_{u_1,1}, \Gamma_{u_2,1}$，假设分别为$0.2,0.4$。即：  

$$
\begin{aligned}
\Gamma_{u,1} = \text{diag}(\Gamma_{u_1,1}, \Gamma_{u_2,1}) =
\begin{bmatrix}
0.2 & 0 \\
0 & 0.4
\end{bmatrix}
\end{aligned}
$$

下一时刻$i=2$时，对这个2个控制量分别采用不同的加权因子$\Gamma_{u_1,2}, \Gamma_{u_2,2}$，假设分别为$0.3,0.1$。即：  

$$
\begin{aligned}
\Gamma_{u,2} = \text{diag}(\Gamma_{u_1, 2}, \Gamma_{u_2, 2}) =
\begin{bmatrix}
0.3 & 0 \\
0 & 0.1
\end{bmatrix}
\end{aligned}
$$  

上述的加权因子在整个预测时域中会变化，称为时变加权因子。当然，有时系统易于控制时，可以选择恒值的加权因子。  

若把目标函数写为矩阵向量的形式，即：  

$$
\begin{aligned}
J(x(k), \Delta U(k), m, p) = || \Gamma_y (Y_p(k+1|k) - R(k+1)) ||^2 + || \Gamma_u \Delta U(k) ||^2,
\end{aligned}
$$  

其中：  
$$
\begin{aligned}
\Gamma_y &= \text{diag}(\Gamma_{y,1}, \Gamma_{y,2}, \cdots, \Gamma_{y,p}), \\
\Gamma_u &= \text{diag}(\Gamma_{u,1}, \Gamma_{u,2}, \cdots, \Gamma_{u,m}),
\end{aligned}
$$

注意，这个$\Gamma_{y,1}, \Gamma_{y,2}, \cdots, \Gamma_{y,p}$与$\Gamma_{u,1}, \Gamma_{u,2}, \cdots, \Gamma_{u,m}$不再是标量，每一个都是一个对角阵（就是上述例子中每一个时刻对每个分量组合起来的对角阵）。

$$
\begin{aligned}
R(k+1) =
\begin{bmatrix}
r(k+1) \\
r(k+2) \\
\vdots \\
r(k+p)
\end{bmatrix}_{p \times 1}.
\end{aligned}
$$
为参考输入序列。  

为了方便这个优化问题，定义辅助变量:  

$$
\begin{aligned}
\rho \stackrel{\text{def}}{=}
\left[
\begin{array}{c}
\Gamma_y \left( Y_p(k+1|k) - R(k+1) \right) \\
\Gamma_u \Delta U(k)
\end{array}
\right],
\end{aligned}
$$

那么目标函数$J(x(k), \Delta U(k), m, p)=\rho ^T\rho$;
## 优化解的第一个元素作用于系统




